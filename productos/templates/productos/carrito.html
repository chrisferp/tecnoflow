<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-product {
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 10px;
            display: flex;
            align-items: center;
            background-color: white;
        }
        .cart-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-right: 15px;
        }
        .btn-qty {
            width: 32px;
            height: 32px;
            text-align: center;
            padding: 0;
        }
        .btn-remove {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .btn-remove:hover {
            background-color: #c82333;
        }
        .total-box {
            font-size: 1.6rem;
            font-weight: bold;
            color: #333;
        }
        .btn-checkout {
            background-color: #28a745;
            color: white;
            font-size: 1.2rem;
            padding: 12px;
            border-radius: 8px;
        }
        .btn-checkout:hover {
            background-color: #218838;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h2 class="mb-4">üõí Carrito de Compras</h2>

        {% if carrito %}
            {% for codigo, item in carrito.items %}
            <div class="card-product" data-codigo="{{ codigo }}">
                <img src="{{ item.imagen }}" class="cart-img" alt="Imagen">
                <div class="flex-grow-1">
                    <h6 class="mb-1">{{ item.detalle }}</h6>
                    <p class="mb-0 text-success fw-bold">Precio: ${{ item.precio|floatformat:2 }}</p>
                </div>
                <div class="d-flex align-items-center mx-3">
                    <button class="btn btn-outline-secondary btn-sm btn-qty minus">-</button>
                    <input type="text" class="form-control text-center mx-2 cantidad" value="{{ item.cantidad }}" style="width:50px;" readonly>
                    <button class="btn btn-outline-secondary btn-sm btn-qty plus">+</button>
                </div>
                <div class="fw-bold subtotal me-3">
                    ${{ item.precio|floatformat:2 }}
                </div>
                <a href="/carrito/eliminar/{{ codigo }}/" class="btn-remove">‚ùå</a>
            </div>
            {% endfor %}

            <div class="text-end total-box mt-3">
                Total: $<span id="total">{{ total|floatformat:2 }}</span>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a href="/productos/" class="btn btn-secondary btn-lg">‚¨Ö Seguir comprando</a>
                <a href="/checkout/" class="btn btn-checkout btn-lg">‚úÖ Ir a Checkout</a>
            </div>
        {% else %}
            <p>No hay productos en el carrito.</p>
        {% endif %}
    </div>

    <script>
        function actualizarServidor(codigo, cantidad){
            fetch("/carrito/actualizar/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: "codigo=" + codigo + "&cantidad=" + cantidad
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === "ok"){
                    document.querySelector(`div[data-codigo="${codigo}"] .subtotal`).textContent = `$${data.subtotal.toFixed(2)}`;
                    document.getElementById("total").textContent = data.total.toFixed(2);
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.querySelectorAll(".plus").forEach(btn => {
            btn.addEventListener("click", function(){
                let row = this.closest(".card-product");
                let input = row.querySelector(".cantidad");
                let cantidad = parseInt(input.value) + 1;
                input.value = cantidad;
                actualizarServidor(row.dataset.codigo, cantidad);
            });
        });

        document.querySelectorAll(".minus").forEach(btn => {
            btn.addEventListener("click", function(){
                let row = this.closest(".card-product");
                let input = row.querySelector(".cantidad");
                let cantidad = parseInt(input.value);
                if(cantidad > 1){
                    cantidad--;
                    input.value = cantidad;
                    actualizarServidor(row.dataset.codigo, cantidad);
                }
            });
        });
    </script>
</body>
</html>
